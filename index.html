<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ç†Šå­¦æ­¦åŠŸï¼šåŠŸå¤«èŠ‚å¥æŒ‘æˆ˜</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Font Awesome for speaker icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 

    <style>
        /* é¡µé¢æ•´ä½“æ ·å¼ */
        body {
            font-family: 'Zhi Mang Xing', cursive, sans-serif;
            background-color: #f7e0b5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            flex-direction: column;
        }

        /* æ¸¸æˆå®¹å™¨ */
        .game-container {
            width: 95%;
            max-width: 900px;
            height: 800px; /* PCç«¯é«˜åº¦ä¸å˜ï¼Œå°†åœ¨æ‰‹æœºç«¯è°ƒæ•´ */
            background: linear-gradient(to bottom, #aed581, #dce775);
            border-radius: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            border: 8px solid #8bc34a;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        .info-bar {
            background-color: #558b2f;
            color: #fff;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.6em;
            font-weight: bold;
            border-bottom: 4px solid #33691e;
            font-family: 'Press Start 2P', cursive;
        }
        .info-bar span {
            margin: 0 15px;
        }
        .info-bar .level {
            font-size: 0.8em;
            color: #cddc39;
        }
        #bgMusicToggle {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
            transition: color 0.3s ease;
        }
        #bgMusicToggle:hover {
            color: #cddc39;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .play-area {
            flex-grow: 1;
            position: relative; /* ä¿æŒç›¸å¯¹å®šä½ï¼Œç”¨äºåé¦ˆæç¤ºçš„ç»å¯¹å®šä½ */
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ—å†…å®¹ */
            align-items: center;
            justify-content: flex-start; /* è°ƒæ•´ä¸ºä»é¡¶éƒ¨å¼€å§‹å¸ƒå±€ */
            padding: 10px; /* å‡å°‘play-areaçš„å†…è¾¹è·ï¼Œå¢åŠ å†…å®¹ç©ºé—´ */
        }

        /* å¸ˆå‚…å›¾æ ‡ */
        #master {
            position: absolute; /* è°ƒæ•´ä¸ºç»å¯¹å®šä½ï¼Œç²¾ç¡®æ§åˆ¶ä½ç½® */
            top: 0px; /* å¸ˆå‚…è¿›ä¸€æ­¥é ä¸Šï¼Œç¡®ä¿å¤´éƒ¨å®Œå…¨éœ²å‡º */
            left: 50%;
            transform: translateX(-50%);
            font-size: 7em;
            color: rgba(0, 0, 0, 0.7);
            user-select: none;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 5;
            line-height: 1;
        }
        /* å¸ˆå‚…çš„æ‹›å¼æç¤º */
        .master-move-display {
            position: absolute; /* ä¿æŒç»å¯¹å®šä½ */
            top: 20%; /* æç¤ºè¯ä½ç½®ä¸Šç§»ï¼Œç´§é‚»å¸ˆå‚…ä¸‹æ–¹ */
            left: 50%;
            transform: translate(-50%, -50%); /* ç¡®ä¿å±…ä¸­ */
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-size: 4em;
            color: #d84315;
            font-weight: bold;
            text-align: center;
            min-width: 150px;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 15; /* ç¡®ä¿åœ¨å¸ˆå‚…ä¹‹ä¸Š */
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .master-move-display.show {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
        .master-move-display .text {
            font-size: 0.4em;
            color: #333;
            margin-top: 5px;
        }
        /* å¤§ç†Šå›¾æ ‡ */
        #bear {
            position: absolute; /* è°ƒæ•´ä¸ºç»å¯¹å®šä½ */
            top: 40%; /* è°ƒæ•´å¤§ç†Šä½ç½®ï¼Œä½¿å…¶åœ¨å¸ˆå‚…å‡ºæ‹›æç¤ºå’Œè¿å‡»æç¤ºä¹‹é—´ */
            left: 50%;
            transform: translateX(-50%);
            font-size: 9em;
            color: #6d4c41;
            user-select: none;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 5;
            line-height: 1;
            display: block; /* æ¢å¤æ˜¾ç¤ºå¤§ç†Š */
        }

        /* ç©å®¶æ“ä½œæŒ‰é’® */
        .player-controls {
            position: absolute; /* ä¿æŒç»å¯¹å®šä½ */
            bottom: -3px; /* è°ƒæ•´åˆ°å¤§ç†Šä¸Šæ–¹ï¼Œå¹¶ç•™å‡ºä¸éŸ³ä¹æ’­æ”¾å™¨çš„é—´è· */
            left: 50%;
            transform: translateX(-50%);
            /* å…³é”®ä¿®æ”¹ï¼šæ”¹ä¸º2åˆ—å¸ƒå±€ï¼Œä½¿å…¶æ¥è¿‘æ–¹å½¢ */
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2åˆ—å¸ƒå±€ */
            gap: 15px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 10;
            /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œä½¿å…¶æ›´ç´§å‡‘å‘ˆæ–¹å½¢ */
            max-width: 250px; 
        }
        .action-button {
            width: 100px; /* æŒ‰é’®å¤§å° */
            height: 100px; /* æŒ‰é’®å¤§å° */
            background-color: #ffb300;
            border: 3px solid #fb8c00;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .action-button:hover:not(:disabled) {
            background-color: #ffa000;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .action-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background-color: #e65100;
        }
        .action-button:disabled {
            background-color: #cccccc;
            border-color: #bbbbbb;
            color: #a0a0a0;
            cursor: not-allowed;
            box-shadow: none;
        }
        .action-button .text {
            font-size: 0.4em;
            color: #333;
            margin-top: 5px;
        }

        /* æ¸¸æˆåé¦ˆæç¤º (è¿å‡»æç¤ºè¯å›¾æ ‡) */
        .feedback {
            position: absolute;
            top: 35%; /* è°ƒæ•´ä½ç½®ï¼Œä½¿å…¶åœ¨å¸ˆå‚…å‡ºæ‹›æç¤ºå’Œæ“ä½œæŒ‰é’®ä¹‹é—´ */
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 6em;
            font-weight: bold;
            color: #F44336; /* é»˜è®¤æ˜¾ç¤ºçº¢è‰²â€œé”™è¯¯ï¼â€ */
            text-shadow: 4px 4px 8px rgba(0,0,0,0.6);
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 20;
            pointer-events: none;
            white-space: nowrap;
        }
        .feedback.show {
            opacity: 1;
            transform: translate(-50%, -70%);
        }
        .feedback.wrong {
            color: #F44336; /* çº¢è‰²è¡¨ç¤ºé”™è¯¯ */
        }
        .feedback.combo {
            color: #FFEB3B; /* äº®é»„è‰²è¡¨ç¤ºè¿å‡» */
            font-size: 7em;
            animation: pulse 0.5s ease-out forwards;
        }
        .feedback.correct {
            color: #4CAF50; /* ç»¿è‰²è¡¨ç¤ºæ­£ç¡® */
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            50% { transform: translate(-50%, -60%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -70%) scale(1); opacity: 0; }
        }

        /* æ¸¸æˆç»“æŸæˆ–å¼€å§‹å‰çš„å åŠ å±‚ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 30;
            flex-direction: column;
            color: white;
            font-size: 2.2em;
            text-align: center;
            border-radius: 25px;
        }
        .overlay h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        .overlay p {
            font-size: 0.8em;
            margin-top: -10px;
            margin-bottom: 30px;
        }
        .overlay button {
            background-color: #ffb300;
            color: #fff;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .overlay button:hover {
            background-color: #ffa000;
        }
        .overlay.hidden {
            display: none !important; 
            opacity: 0;
            pointer-events: none; 
        }

        /* æ”¾æ¾éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
        .relax-music-player {
            width: calc(100% - 40px);
            background-color: #e0f2f7;
            padding: 15px 20px;
            border-radius: 15px;
            margin-top: 20px; /* ç¡®ä¿ä¸ä¸Šæ–¹æ“ä½œæŒ‰é’®æœ‰è¶³å¤Ÿé—´è· */
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #b2ebf2;
            z-index: 5;
        }
        .relax-music-player h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #00bcd4;
            font-size: 1.2em;
        }
        .relax-music-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            justify-content: center;
            flex-wrap: wrap;
        }
        .relax-music-controls button {
            background-color: #4dd0e1;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .relax-music-controls button:hover {
            background-color: #26c6da;
        }
        .relax-music-controls input[type="range"] {
            width: 100px;
            -webkit-appearance: none;
            height: 6px;
            background: #b2ebf2;
            border-radius: 3px;
            outline: none;
        }
        .relax-music-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00bcd4;
            cursor: pointer;
        }
        .relax-music-controls label {
            font-size: 0.9em;
            color: #00838f;
        }
        /* éŸ³ä¹é€‰æ‹©å™¨å¸ƒå±€è°ƒæ•´ - æ¨ªå‘æ’åˆ— */
        .music-selector-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            width: 100%;
        }
        .music-selector {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
            min-width: 180px; /* ç¡®ä¿æœ‰è¶³å¤Ÿå®½åº¦ */
            justify-content: center;
        }
        .music-selector label {
            font-size: 0.9em;
            color: #00838f;
            white-space: nowrap;
        }
        .music-selector select {
            padding: 5px 8px;
            border-radius: 8px;
            border: 1px solid #00bcd4;
            background-color: #e0f7fa;
            color: #00838f;
            font-size: 0.9em;
            cursor: pointer;
            flex-grow: 1;
            min-width: 80px;
            max-width: 180px;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .game-container {
                height: 95vh; /* ä½¿ç”¨è§†å£é«˜åº¦ï¼Œç¡®ä¿é€‚åº”ä¸åŒæ‰‹æœºå±å¹•ï¼Œä¿ç•™é¡¶éƒ¨çŠ¶æ€æ å’Œåº•éƒ¨æµè§ˆå™¨å¯¼èˆª */
                width: 98%;
                border-radius: 20px;
            }
                /* ä¿¡æ¯æ åŸºç¡€æ ·å¼ */
         .info-bar {
            padding: 2vh 4vw;  /* è§†å£å•ä½ï¼Œè‡ªåŠ¨é€‚åº” */
            font-size: min(4vw, 16px); /* æœ€å¤§16pxï¼Œè‡ªåŠ¨ç¼©å° */
            box-sizing: border-box;
            width: 100%;
        }

        .info-bar span {
            margin: 0 max(5px, 1vw); /* æœ€å°5pxï¼ŒæŒ‰æ¯”ä¾‹æ”¾å¤§ */
        }

         .info-bar {
            overflow-x: auto;  /* å…è®¸æ°´å¹³æ»šåŠ¨ */
            -webkit-overflow-scrolling: touch; /* æ‰‹æœºå¹³æ»‘æ»šåŠ¨ */
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .info-bar::-webkit-scrollbar {
            display: none;
        }

            #master {
                top: -10px; /* æ‰‹æœºç«¯å¸ˆå‚…è¿›ä¸€æ­¥é ä¸Šï¼Œç¡®ä¿å¤´éƒ¨å®Œå…¨éœ²å‡º */
                font-size: 5em;
            }
            /* å¤§ç†Šå›¾æ ‡ä½ç½® */
            #bear {
                top: 35%; /* è°ƒæ•´å¤§ç†Šä½ç½®ï¼Œä½¿å…¶åœ¨å¸ˆå‚…å‡ºæ‹›æç¤ºå’Œè¿å‡»æç¤ºä¹‹é—´ï¼Œä¸”èƒ½è¢«çœ‹åˆ° */
                font-size: 7em;
                display: block; /* æ¢å¤æ˜¾ç¤ºå¤§ç†Š */
            }
            .master-move-display {
                top: 15%; /* æ‰‹æœºç«¯å¸ˆå‚…æ‹›å¼æç¤ºä½ç½®è¿›ä¸€æ­¥ä¸Šç§»ï¼Œç´§è´´å¸ˆå‚… */
                font-size: 3em;
                padding: 10px 15px;
                min-height: 60px;
            }
            .feedback {
                top: 25%; /* æ‰‹æœºç«¯è¿å‡»æç¤ºè¿›ä¸€æ­¥ä¸Šç§»ï¼Œé¿å…ä¸masterMoveDisplayé‡å ï¼Œå¹¶ç¡®ä¿åœ¨bearä¸Šæ–¹ */
                font-size: 4em;
            }
            .feedback.combo {
                font-size: 5em;
            }
            .player-controls {
                grid-template-columns: repeat(2, 1fr); /* æ‰‹æœºç«¯ç»´æŒ2åˆ— */
                gap: 10px;
                padding: 15px;
                bottom: 270px; /* æ‰‹æœºç«¯æ“ä½œæŒ‰é’®å¤§å¹…åº¦ä¸Šç§»ï¼Œä¸ºéŸ³ä¹æ’­æ”¾å™¨å’Œåº•éƒ¨é—´è·ç•™å‡ºæ›´å¤šå®‰å…¨ç©ºé—´ */
                max-width: 200px; /* é™åˆ¶æ‰‹æœºç«¯æŒ‰é’®åŒºåŸŸå®½åº¦ */
            }
            .action-button {
                width: 70px; /* æ‰‹æœºç«¯æŒ‰é’®æ›´å° */
                height: 70px; /* æ‰‹æœºç«¯æŒ‰é’®æ›´å° */
                font-size: 2.2em;
            }
            .action-button .text {
                font-size: 0.3em;
            }
            .overlay {
                font-size: 1.5em;
            }
            .overlay h2 {
                font-size: 1.2em;
            }
            .overlay p {
                font-size: 0.7em;
            }
            .overlay button {
                padding: 10px 20px;
                font-size: 1.2em;
            }
            .relax-music-player {
                padding: 10px 15px;
                position: absolute; /* ç»å¯¹å®šä½ï¼Œä»åº•éƒ¨è®¡ç®— */
                bottom: 0px; /* è´´åˆåº•éƒ¨ */
                left: 50%;
                transform: translateX(-50%);
                width: calc(100% - 40px); /* ä¿æŒå®½åº¦ */
                box-sizing: border-box; /* ç¡®ä¿paddingä¸ä¼šæ’‘å¼€å®½åº¦ */
                height: auto; /* è‡ªåŠ¨é«˜åº¦ä»¥é€‚åº”å†…å®¹ï¼Œç¡®ä¿ä¸è¢«æˆªæ–­ */
            }
            .relax-music-player h3 {
                font-size: 1.1em;
            }
            .relax-music-controls {
                flex-direction: column;
                gap: 8px;
            }
            .relax-music-controls input[type="range"] {
                width: 80%;
            }
            .music-selector-row {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
                width: 100%;
            }
            .music-selector {
                width: 100%;
                justify-content: flex-start;
            }
            .music-selector select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Game Background Music -->
        <audio id="game-bg-music" loop>
            Your browser does not support game background music.
        </audio>

        <div class="info-bar">
            <span>Time: <span id="timer">60</span>s</span>
            <span>Score: <span id="score">0</span></span>
            <span>Combo: <span id="combo">0</span></span>
            <span class="level">Level: <span id="level">Apprentice</span></span>
            <button id="bgMusicToggle" title="Toggle Background Music">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>

        <div class="play-area">
            <!-- Master Icon -->
            <div id="master" class="character">ğŸ‘¨â€ğŸ«</div>
            <!-- Bear Icon -->
            <div id="bear" class="character">ğŸ»</div>

            <div id="masterMoveDisplay" class="master-move-display">
                <span class="emoji"></span>
                <div class="text"></div>
            </div>

            <div id="feedback" class="feedback"></div>

            <div class="player-controls">
                <button class="action-button" data-action="left-punch">
                    <span>ğŸ‘Š</span><div class="text">Left Punch</div>
                </button>
                <button class="action-button" data-action="right-punch">
                    <span>ğŸ¤œ</span><div class="text">Right Punch</div>
                </button>
                <button class="action-button" data-action="up-kick">
                    <span>ğŸ¤¸</span><div class="text">Up Kick</div>
                </button>
                <button class="action-button" data-action="down-block">
                    <span>ğŸ›¡ï¸</span><div class="text">Down Block</div>
                </button>
                <button class="action-button" data-action="jump">
                    <span>â¬†ï¸</span><div class="text">Jump</div>
                </button>
                <button class="action-button" data-action="crouch">
                    <span>â¤µï¸</span><div class="text">Crouch</div>
                </button>
            </div>
        </div>

        <div class="relax-music-player">
            <div class="music-selector-row">
                <div class="music-selector">
                    <label for="bgMusicSelector">Game Music:</label>
                    <select id="bgMusicSelector"></select>
                </div>
                <div class="music-selector">
                    <label for="relaxMusicSelector">Relax Music:</label>
                    <select id="relaxMusicSelector"></select>
                </div>
            </div>
            <h3>ğŸµ Relax Music Controls ğŸµ</h3>
            <audio id="relax-audio" loop>
                Your browser does not support relax music.
            </audio>
            <div class="relax-music-controls">
                <button id="relaxPlayButton">Play</button>
                <button id="relaxPauseButton">Pause</button>
                <label for="relaxVolumeSlider">Volume:</label>
                <input type="range" id="relaxVolumeSlider" min="0" max="1" step="0.05" value="0.5">
            </div>
        </div>

        <div class="overlay" id="gameOverlay">
            <h2>Bear Kung Fu Challenge!</h2>
            <p>Watch the master demonstrate, then quickly tap the correct move!</p>
            <button id="startButton">Start Training</button>
        </div>
    </div>

    <script>
        // --- Element Retrieval ---
        const timerElement = document.getElementById('timer');
        const scoreElement = document.getElementById('score');
        const comboElement = document.getElementById('combo');
        const levelElement = document.getElementById('level');
        const masterMoveDisplay = document.getElementById('masterMoveDisplay');
        const masterMoveEmoji = masterMoveDisplay.querySelector('.emoji');
        const masterMoveText = masterMoveDisplay.querySelector('.text');
        const actionButtons = document.querySelectorAll('.action-button');
        const feedbackDisplay = document.getElementById('feedback');
        const gameOverlay = document.getElementById('gameOverlay');
        const startButton = document.getElementById('startButton');

        // Game music elements
        const gameBgMusic = document.getElementById('game-bg-music');
        const bgMusicToggle = document.getElementById('bgMusicToggle');
        const bgMusicIcon = bgMusicToggle.querySelector('i');
        const bgMusicSelector = document.getElementById('bgMusicSelector');
        gameBgMusic.volume = 0.3;
        let isGameBgMusicPlaying = false;

        // Relax music elements
        const relaxAudio = document.getElementById('relax-audio');
        const relaxPlayButton = document.getElementById('relaxPlayButton');
        const relaxPauseButton = document.getElementById('relaxPauseButton');
        const relaxVolumeSlider = document.getElementById('relaxVolumeSlider');
        const relaxMusicSelector = document.getElementById('relaxMusicSelector');
        relaxAudio.volume = relaxVolumeSlider.value;

        // --- Game State Variables ---
        let score = 0;
        let combo = 0;
        let timeLeft = 60; 
        let gameInterval; 
        let moveInterval;
        let isGameRunning = false;
        let expectedMoveId = null;
        let moveTimeout = null;
        let level = 1;

        // --- Game Data ---
        const moves = [
            { id: 'left-punch', emoji: 'ğŸ‘Š', text: 'Left Punch' },
            { id: 'right-punch', emoji: 'ğŸ¤œ', text: 'Right Punch' },
            { id: 'up-kick', emoji: 'ğŸ¤¸', text: 'Up Kick' },
            { id: 'down-block', emoji: 'ğŸ›¡ï¸', text: 'Down Block' },
            { id: 'jump', emoji: 'â¬†ï¸', text: 'Jump' },
            { id: 'crouch', emoji: 'â¤µï¸', text: 'Crouch' }
        ];

        const levels = [
            { scoreThreshold: 0, name: 'Apprentice', moveSpeed: 1500 },
            { scoreThreshold: 100, name: 'Bear Trainee', moveSpeed: 1200 },
            { scoreThreshold: 300, name: 'Kung Fu Bear', moveSpeed: 1000 },
            { scoreThreshold: 600, name: 'Disciple Master', moveSpeed: 800 },
            { scoreThreshold: 1000, name: 'Bear Overlord', moveSpeed: 600 }
        ];

        // Music lists - strictly according to knowledge base
        const gameMusicList = [
            { name: "Kung Fu Rhythm", src: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3" },
            { name: "Exhilarating Strike", src: "https://assets.mixkit.co/sfx/preview/mixkit-martial-arts-punch-2047.mp3" },
            { name: "Mountain Forest Cultivation", src: "https://www.bensound.com/bensound-music/bensound-littleidea.mp3" }
        ];

        const relaxMusicList = [
            { name: "Forest Lullaby", src: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Forest-Lullaby.mp3" },
            { name: "Rainforest Meditation", src: "https://assets.mixkit.co/sfx/preview/mixkit-forest-stream-loop-2009.mp3" },
            { name: "Ocean Waves", src: "https://www.bensound.com/bensound-music/bensound-relaxing.mp3" }
        ];

        // --- Music Playback Helper Functions ---
        async function loadAndPlayMusic(audioElement, src, shouldPlay) {
            console.log(`Attempting to load: ${src}, Expected to play: ${shouldPlay}`);
            audioElement.src = src;
            audioElement.load(); 
            
            if (shouldPlay) {
                try {
                    await new Promise((resolve, reject) => {
                        const onCanPlayThrough = () => {
                            console.log(`Audio canplaythrough: ${src}`);
                            audioElement.removeEventListener('canplaythrough', onCanPlayThrough);
                            audioElement.removeEventListener('loadeddata', onLoadedData);
                            audioElement.removeEventListener('error', onError);
                            resolve();
                        };
                        const onLoadedData = () => { 
                            console.log(`Audio loadeddata: ${src}`);
                            audioElement.removeEventListener('canplaythrough', onCanPlayThrough);
                            audioElement.removeEventListener('loadeddata', onLoadedData);
                            audioElement.removeEventListener('error', onError);
                            resolve();
                        };
                        const onError = (e) => {
                            console.error(`Audio error during load/play: ${src}`, e);
                            audioElement.removeEventListener('canplaythrough', onCanPlayThrough);
                            audioElement.removeEventListener('loadeddata', onLoadedData);
                            audioElement.removeEventListener('error', onError);
                            reject(new Error(`Audio load error for ${src}: ${e.message || e.type}`));
                        };

                        audioElement.addEventListener('canplaythrough', onCanPlayThrough);
                        audioElement.addEventListener('loadeddata', onLoadedData);
                        audioElement.addEventListener('error', onError);
                        
                        if (audioElement.readyState >= 4) { 
                            onCanPlayThrough();
                        } else if (audioElement.readyState >= 2) { 
                            onLoadedData();
                        }
                        
                        setTimeout(() => {
                            reject(new Error(`Audio load timeout for ${src}`));
                        }, 7000); 
                    });

                    await audioElement.play();
                    console.log(`Music ${src} played successfully.`);
                    return true;
                } catch (e) {
                    console.warn(`Music playback failed (URL: ${src}), may require user interaction or invalid link/format:`, e);
                    return false;
                }
            }
            return false;
        }

        // Populate music selectors
        function populateMusicSelectors() {
            bgMusicSelector.innerHTML = '';
            relaxMusicSelector.innerHTML = '';

            gameMusicList.forEach((music) => {
                const option = document.createElement('option');
                option.value = music.src;
                option.textContent = music.name;
                bgMusicSelector.appendChild(option);
            });
            if (gameMusicList.length > 0) {
                gameBgMusic.src = gameMusicList[0].src;
                gameBgMusic.load();
            }

            relaxMusicList.forEach((music) => {
                const option = document.createElement('option');
                option.value = music.src;
                option.textContent = music.name;
                relaxMusicSelector.appendChild(option);
            });
            if (relaxMusicList.length > 0) {
                relaxAudio.src = relaxMusicList[0].src;
                relaxAudio.load();
            }
        }

        // --- Core Game Logic ---

        function resetGame() {
            score = 0;
            combo = 0;
            timeLeft = 60; 
            level = 1;
            scoreElement.textContent = score;
            comboElement.textContent = combo;
            timerElement.textContent = timeLeft;
            levelElement.textContent = levels[0].name;
            
            // Ensure all timers are cleared on reset
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null; 
            } 
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
            if (moveTimeout) {
                clearTimeout(moveTimeout);
                moveTimeout = null;
            }
            
            isGameRunning = false; 
            expectedMoveId = null;
            masterMoveDisplay.classList.remove('show');
            feedbackDisplay.classList.remove('show', 'correct', 'wrong', 'combo');
            feedbackDisplay.textContent = ''; 
            enableActionButtons(true);

            gameBgMusic.pause();
            gameBgMusic.currentTime = 0;
            isGameBgMusicPlaying = false;
            bgMusicIcon.classList.remove('fa-volume-mute');
            bgMusicIcon.classList.add('fa-volume-up');

            relaxAudio.pause();
            relaxAudio.currentTime = 0;
        }

        async function startGame() {
            console.log("startGame called.");
            // alert("Game is starting!"); // Temporarily remove alert to avoid blocking, use console.log

            // If game is already running or starting, ignore duplicate calls
            if (isGameRunning) { 
                console.log("Game is already running or starting, ignoring duplicate call.");
                return;
            }
            
            resetGame(); // Reset all states and timers before starting a new game
            
            // Critical: Hide overlay before setting isGameRunning=true, to prevent race conditions
            gameOverlay.classList.add('hidden'); 
            
            // Add a short delay to ensure the browser has time to process DOM updates and rendering
            await new Promise(resolve => setTimeout(resolve, 100)); 

            isGameRunning = true; // Set to true immediately, ensuring updateTimer can execute
            
            try { // Add try-catch block to catch potential errors in setInterval
                gameInterval = setInterval(updateTimer, 1000); // **Ensure this is set only once, with 1000ms interval**
                console.log("Game interval set with ID:", gameInterval); // Print timer ID
            } catch (error) {
                console.error("Failed to set gameInterval:", error);
                // alert("Game failed to start: Timer could not be created. Check browser console.");
                isGameRunning = false; // Reset state if start fails
                gameOverlay.classList.remove('hidden'); // If start fails, re-show Overlay
                return;
            }
            
            startNewMoveSequence();

            // Music playback logic remains unchanged
            if (isGameBgMusicPlaying) {
                await loadAndPlayMusic(gameBgMusic, bgMusicSelector.value, true);
            }
            relaxAudio.pause();
            console.log("startGame finished. Game is running.");
        }

        function updateTimer() {
            // Only update time if the game is running
            if (!isGameRunning) { 
                if (gameInterval) { // If game stopped but timer is still running, clear it
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
                console.log("updateTimer called but game is not running."); // Debug info
                return;
            }
            timeLeft--;
            timerElement.textContent = timeLeft;
            console.log("Time left:", timeLeft, " (isGameRunning:", isGameRunning, ")"); // Print time to console, observe changes
            if (timeLeft <= 0) {
                endGame();
            }
        }

        function startNewMoveSequence() {
            if (moveInterval) clearInterval(moveInterval); // Ensure old move timer is cleared
            let currentLevelData = levels[0]; 
            for (let i = levels.length - 1; i >= 0; i--) {
                if (score >= levels[i].scoreThreshold) {
                    currentLevelData = levels[i];
                    level = i + 1; 
                    break;
                }
            }
            levelElement.textContent = currentLevelData.name;
            moveInterval = setInterval(showNextMove, currentLevelData.moveSpeed); // Use current level's rhythm
            showNextMove(); 
        }

        function showNextMove() {
            if (!isGameRunning) return;

            clearTimeout(moveTimeout); 

            if (expectedMoveId !== null) {
                handleWrongGuess(null); 
            }
            
            masterMoveDisplay.classList.remove('show'); 
            
            const randomIndex = Math.floor(Math.random() * moves.length);
            const nextMove = moves[randomIndex];

            masterMoveEmoji.textContent = nextMove.emoji;
            masterMoveText.textContent = nextMove.text;
            masterMoveDisplay.classList.add('show');
            
            expectedMoveId = nextMove.id; 

            actionButtons.forEach(button => {
                button.disabled = false;
                button.classList.remove('correct', 'wrong');
            });

            const currentLevelData = levels.find(l => score >= l.scoreThreshold) || levels[levels.length - 1];
            moveTimeout = setTimeout(() => { 
                if (expectedMoveId !== null && isGameRunning) { 
                    handleWrongGuess(null);
                }
            }, currentLevelData.moveSpeed - 200); 
        }

        function handlePlayerAction(event) {
            console.log("Player action clicked. Expected:", expectedMoveId, "Clicked:", event.currentTarget.dataset.action);
            if (!isGameRunning || expectedMoveId === null) {
                console.log("Action ignored: Not running or no expected move.");
                return; 
            }

            clearTimeout(moveTimeout); 
            
            const clickedAction = event.currentTarget.dataset.action;
            const isCorrect = (clickedAction === expectedMoveId); 
            
            expectedMoveId = null; 
            masterMoveDisplay.classList.remove('show'); 
            enableActionButtons(false);

            if (isCorrect) { 
                console.log("Correct!");
                score += (10 + combo * 2); 
                combo++;
                scoreElement.textContent = score;
                comboElement.textContent = combo; 

                if (combo > 1) {
                    showFeedback(`Combo x${combo}!`, 'combo');
                } else {
                    showFeedback('Correct!', 'correct');
                }
                
                const nextLevelThreshold = levels[level] ? levels[level].scoreThreshold : Infinity; 
                if (score >= nextLevelThreshold) {
                    level++; 
                    levelElement.textContent = levels[level-1].name;
                    startNewMoveSequence(); 
                    showFeedback(`Level Up!`, 'combo');
                }
            } else { 
                console.log("Wrong!");
                handleWrongGuess(event.currentTarget);
            }
        }

        function handleWrongGuess(clickedButton) {
            score = Math.max(0, score - 5); 
            combo = 0; 
            scoreElement.textContent = score;
            comboElement.textContent = combo; 
            showFeedback('Wrong!', 'wrong');

            if (clickedButton) {
                clickedButton.classList.add('wrong'); 
            }
            expectedMoveId = null; 
        }

        function showFeedback(text, type) {
            feedbackDisplay.classList.remove('show', 'correct', 'wrong', 'combo');
            feedbackDisplay.textContent = text;
            feedbackDisplay.classList.add('show');
            if (type) {
                feedbackDisplay.classList.add(type);
            }

            setTimeout(() => {
                feedbackDisplay.classList.remove('show');
            }, 1000); 
        }

        function enableActionButtons(enable) {
            actionButtons.forEach(button => {
                button.disabled = !enable;
            });
        }

        function endGame() {
            clearInterval(gameInterval);
            clearInterval(moveInterval);
            clearTimeout(moveTimeout); 
            isGameRunning = false;
            enableActionButtons(false);
            masterMoveDisplay.classList.remove('show'); 
            expectedMoveId = null; 

            gameBgMusic.pause();
            gameBgMusic.currentTime = 0; 
            isGameBgMusicPlaying = false;
            bgMusicIcon.classList.remove('fa-volume-mute');
            bgMusicIcon.classList.add('fa-volume-up');

            gameOverlay.classList.remove('hidden');
            gameOverlay.querySelector('h2').textContent = 'Training Ended!';
            gameOverlay.querySelector('p').textContent = `Your final score is: ${score}, and Bear reached the ${levelElement.textContent} realm!`;
            gameOverlay.querySelector('button').textContent = 'Play Again';
        }

        // --- Event Listeners ---
        actionButtons.forEach(button => {
            button.addEventListener('click', handlePlayerAction);
        });

        bgMusicToggle.addEventListener('click', async () => {
            if (gameBgMusic.paused) {
                const success = await loadAndPlayMusic(gameBgMusic, bgMusicSelector.value, true);
                if (success) {
                    isGameBgMusicPlaying = true;
                    bgMusicIcon.classList.remove('fa-volume-mute');
                    bgMusicIcon.classList.add('fa-volume-up');
                    if (!relaxAudio.paused) {
                        relaxAudio.pause();
                    }
                }
            } else {
                gameBgMusic.pause();
                isGameBgMusicPlaying = false;
                bgMusicIcon.classList.remove('fa-volume-up');
                bgMusicIcon.classList.add('fa-volume-mute');
            }
        });

        bgMusicSelector.addEventListener('change', async (e) => {
            const newSrc = e.target.value;
            const wasPlaying = isGameBgMusicPlaying;
            gameBgMusic.pause();
            gameBgMusic.currentTime = 0;
            const success = await loadAndPlayMusic(gameBgMusic, newSrc, wasPlaying);
            if (success) {
                isGameBgMusicPlaying = true;
                bgMusicIcon.classList.remove('fa-volume-mute');
                bgMusicIcon.classList.add('fa-volume-up');
                if (!relaxAudio.paused) {
                    relaxAudio.pause();
                }
            } else {
                isGameBgMusicPlaying = false;
                bgMusicIcon.classList.remove('fa-volume-up');
                bgMusicIcon.classList.add('fa-volume-mute');
            }
        });

        relaxPlayButton.addEventListener('click', async () => {
            const success = await loadAndPlayMusic(relaxAudio, relaxMusicSelector.value, true);
            if (success) {
                if (!gameBgMusic.paused) {
                    gameBgMusic.pause();
                    isGameBgMusicPlaying = false;
                    bgMusicIcon.classList.remove('fa-volume-up');
                    bgMusicIcon.classList.add('fa-volume-mute');
                }
            }
        });

        relaxPauseButton.addEventListener('click', () => {
            relaxAudio.pause();
        });

        relaxVolumeSlider.addEventListener('input', () => {
            relaxAudio.volume = relaxVolumeSlider.value;
        });

        relaxMusicSelector.addEventListener('change', async (e) => {
            const newSrc = e.target.value;
            const wasRelaxPlaying = !relaxAudio.paused;
            relaxAudio.pause();
            relaxAudio.currentTime = 0;
            const success = await loadAndPlayMusic(relaxAudio, newSrc, wasRelaxPlaying);
            if (success) {
                if (!gameBgMusic.paused) {
                    gameBgMusic.pause();
                    isGameBgMusicPlaying = false;
                    bgMusicIcon.classList.remove('fa-volume-up');
                    bgMusicIcon.classList.add('fa-volume-mute');
                }
            }
        });

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            populateMusicSelectors();
            gameOverlay.classList.remove('hidden'); 
            startButton.addEventListener('click', startGame); 
            resetGame(); 
        });

    </script>
</body>
</html>








